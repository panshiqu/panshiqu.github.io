---
layout: default
---

# 游戏、网关等服务借助Docker容器化并使用Kubernetes部署、更新等
_2024-08-24 10:00:00_

* * *

请先看完
* [实现负责消息转发、推送的网关服务](093.html)
* [负责网络、定时、坐下、站起、重连等，支持多类游戏的无锁房间](092.html)

## Docker容器化

#### Build and Push
```bash
docker build -t panshiqu/game_server:latest -t panshiqu/game_server:1 -t panshiqu/game_server:1.0 --build-arg SERVER=game_server .
docker build -t panshiqu/gate_server:latest -t panshiqu/gate_server:1 -t panshiqu/gate_server:1.0 --build-arg SERVER=gate_server .

docker push panshiqu/game_server:latest
docker push panshiqu/game_server:1
docker push panshiqu/game_server:1.0
docker push panshiqu/gate_server:latest
docker push panshiqu/gate_server:1
docker push panshiqu/gate_server:1.0
```

#### 验证
```bash
# 创建网络使用别名发现服务
docker network create server

docker run --network server --network-alias dice --name game_server -p 60001:60001 --rm panshiqu/game_server:1.0
docker run --network server --name gate_server -p 60006:60006 -e JWT_KEY=ZGVmYXVsdF9rZXk= --rm panshiqu/gate_server:1.0

cd ~/go/src/github.com/panshiqu/server/game_server/game/dice/client
go run main.go
```

## Kubernetes容器编排

#### 部署
```bash
kubectl apply -f https://raw.githubusercontent.com/panshiqu/server/main/k8s/dice.yaml

kubectl create secret generic jwt --from-literal=key=ZGVmYXVsdF9rZXk=

kubectl apply -f https://raw.githubusercontent.com/panshiqu/server/main/k8s/gate.yaml

minikube service gate --url # Mac DockerDesktop minikube print the port
cd ~/go/src/github.com/panshiqu/server/game_server/game/dice/client
go run main.go -port 60006
```

#### EFK (Elasticsearch + Fluentd + Kibana)
方案取自以下官方文档
* [日志架构](https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/logging/)
* [Fluentd](https://docs.fluentd.org/container-deployment/kubernetes)
* [快速开始系列](https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-quickstart.html)：其中[Elasticsearch](https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-elasticsearch.html)和[Kibana](https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-kibana.html)

```bash
kubectl create -f https://download.elastic.co/downloads/eck/2.14.0/crds.yaml

kubectl apply -f https://download.elastic.co/downloads/eck/2.14.0/operator.yaml

cat <<EOF | kubectl apply -f -
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: quickstart
spec:
  version: 8.15.0
  nodeSets:
  - name: default
    count: 1
    config:
      node.store.allow_mmap: false
EOF

kubectl get secret quickstart-es-elastic-user -o go-template='{{.data.elastic | base64decode}}'

cat <<EOF | kubectl apply -f -
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: quickstart
spec:
  version: 8.15.0
  count: 1
  elasticsearchRef:
    name: quickstart
EOF

kubectl port-forward service/quickstart-kb-http 5601

# 复制修改自：https://github.com/fluent/fluentd-kubernetes-daemonset/blob/master/fluentd-daemonset-elasticsearch-rbac.yaml
curl -s -O https://raw.githubusercontent.com/panshiqu/server/main/k8s/fluentd-daemonset-elasticsearch-rbac.yaml
kubectl apply -f fluentd-daemonset-elasticsearch-rbac.yaml # 请修改密码 FLUENT_ELASTICSEARCH_PASSWORD

# Open https://localhost:5601
```

_未完..._
